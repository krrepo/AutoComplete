<!DOCTYPE HTML>
<html>
<head>

 <link type="text/css" rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.1/css/bootstrap.min.css"/>
 
 <script type="text/javascript">
  //global object for websocket object
  var ws;
 </script>
 
 <script type="text/javascript">

  if (!ws){
    try {
      xmlhttp=new XMLHttpRequest()
    
      xmlhttp.onreadystatechange=function() {
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {
        hsKey=xmlhttp.responseText.match(/[^:]*/);
        ws = new WebSocket("ws://10.45.205.80/socket.io/1/websocket/"+ hsKey[0]);
        }
      }
      xmlhttp.open("POST","//10.45.205.80/socket.io/1/", false);
      xmlhttp.send();
    } catch (e) { alert('Unable to establish websocket.') }
  };

</script>  
  
<script type="text/javascript">
  
  ws.onmessage = function (evt) {

    var now = new Date(); 
    var time = now.getHours()+':'+now.getMinutes()+':'+now.getSeconds()+':'+now.getMilliseconds();
    
    var regexp = /([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;
    var pieces = evt.data.match(regexp);
    //check for our of interest data
    if (!pieces[5]) {
      //check ping-pong
      pieces[1] === '2' ? ws.send('2:::') : {};
      return;
    }
    try {
      data = JSON.parse(pieces[5]);
    } catch (e) { return }

    var entity=document.getElementById("entity").value; 
    for (entityData in data) {
      var entities = data[entityData];
        for (i=0; i< entities[entity].length; i++){
          var item = entities[entity][i];
          output( time + ' ' + item.display );
        }
    }
  };
  ws.onopen = function() {};
  ws.onclose = function() {alert('Socket has closed - refresh browser to restablish.')};
  
</script>

<script type="text/javascript">

  function sendMsg() {

    var entity=document.getElementById("entity").value;
    var msg=document.getElementById("msg").value;
    var word=item="";
    for (i=0; i<msg.length;i++){
      item=msg[i];
      word+=item;
      var jsonObject = {'@class': 'com.glg.service.TrieObject',
                                               entity:entity, 
                                               prefix:word};
      var now = new Date(); 
      var time = now.getHours()+':'+now.getMinutes()+':'+now.getSeconds()+':'+now.getMilliseconds();
   
      output(time + ' sending data...' + word);
      ws.send('4:::'+JSON.stringify(jsonObject));
    }
  };

  function output(message) {
    var div = document.createElement("div");
    div.textContent = message;
    var fragment = document.createDocumentFragment();
    fragment.appendChild(div);
    
    var child=document.getElementById("console").firstChild;
    document.getElementById("console").insertBefore( fragment, child);
  };
</script>

</head>
<body>
    <form class="well form-inline" onsubmit="return false;">
      <input id="entity" class="input-small" type="text" value="cm" />
      <input id="msg" class="input-xlarge" type="text" placeholder="Type something..."/>
      <button type="button" onClick="sendMsg()" class="btn">Send</button>
    </form>
  	<div id="console" class="well">
      <div></div>
  	</div>
</body>
</html>
